"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
const errors_1 = require("../errors");
const utils_1 = require("../utils");
const findMatchInFile = (pattern, file) => new Promise(async (resolve, reject) => {
    try {
        const fd = await utils_1.fsOpenPromise(file, 'r');
        const readStream = fs_1.createReadStream(file, {
            encoding: 'utf-8',
            highWaterMark: 16 * 1024,
        });
        function onError() {
            reject(new errors_1.ReadError(fd));
        }
        function onData(chunk) {
            const found = pattern &&
                pattern.test(chunk);
            if (found) {
                readStream.destroy();
                readStream.emit('end', found);
            }
        }
        async function onEnd(found) {
            try {
                await utils_1.fsClosePromise(fd);
                resolve(found ? file : null);
            }
            catch (err) {
                reject(new errors_1.CloseError(fd));
            }
        }
        readStream.on('error', onError);
        readStream.on('data', onData);
        readStream.on('end', onEnd);
    }
    catch (err) {
        reject(err);
    }
});
exports.default = findMatchInFile;
